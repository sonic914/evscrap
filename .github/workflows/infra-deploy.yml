name: Infrastructure Deployment

on:
  push:
    branches:
      - main
    paths:
      - "infra/**"
      - "core-api/src/**"
      - "core-api/prisma/**"
      - "core-api/scripts/**"
      - "core-api/package.json"
      - "scripts/db-smoke.mjs"
      - "scripts/e2e-idempotency.mjs"
      - "scripts/resolve-outputs.mjs"
      - "scripts/get-api-endpoint.mjs"
      - "scripts/smoke-test.sh"
      - ".github/workflows/infra-deploy.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  AWS_ACCOUNT_ID: "090733632671"

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: |
            core-api/package-lock.json
            infra/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::090733632671:role/GitHubActions-evscrap-deploy-dev
          aws-region: ap-northeast-2
          role-session-name: GitHubActions-deploy

      # ---- Core API Build ----
      - name: Install core-api dependencies
        working-directory: ./core-api
        run: npm ci

      - name: Build TypeScript
        working-directory: ./core-api
        run: npx tsc

      - name: Bundle Lambda
        working-directory: ./core-api
        run: node scripts/bundle-lambda.js

      # ---- CDK Deploy ----
      - name: Install infra dependencies
        working-directory: ./infra
        run: npm ci

      - name: CDK Synth
        working-directory: ./infra
        run: npx cdk synth

      # 기존 Lambda 자동 생성 LogGroup 삭제 (CDK logGroup 전환 1회성)
      - name: Remove orphaned LogGroups (one-time migration)
        run: |
          aws logs delete-log-group --log-group-name /aws/lambda/evscrap-anchor-worker 2>/dev/null || true
          aws logs delete-log-group --log-group-name /aws/lambda/evscrap-api 2>/dev/null || true
          echo "✅ Orphaned LogGroups cleaned up"

      - name: CDK Deploy
        working-directory: ./infra
        run: npx cdk deploy --all --require-approval never --outputs-file cdk-outputs.json

      # ---- DB Migration (via Bastion SSM) ----
      # 비밀번호는 GitHub Actions/SSM 파라미터에 포함되지 않음
      # Bastion이 직접 Secrets Manager에서 읽어서 사용
      - name: Run Prisma Migration (via Bastion SSM)
        run: |
          BASTION_ID=$(aws cloudformation describe-stacks \
            --stack-name EvscrapStack \
            --query 'Stacks[0].Outputs[?OutputKey==`BastionInstanceId`].OutputValue' \
            --output text)
          
          DB_SECRET_ARN=$(aws cloudformation describe-stacks \
            --stack-name EvscrapStack \
            --query 'Stacks[0].Outputs[?OutputKey==`DatabaseSecretArn`].OutputValue' \
            --output text)
          
          DB_HOST=$(aws cloudformation describe-stacks \
            --stack-name EvscrapStack \
            --query 'Stacks[0].Outputs[?OutputKey==`DatabaseProxyEndpoint`].OutputValue' \
            --output text)
          
          SQL_B64=$(base64 -w0 < core-api/prisma/migrations/20260210132900_idempotency_v2/migration.sql)
          
          echo "Applying migrations via Bastion SSM (secrets read on-instance)..."
          
          # 1) DB 연결 확인 — Bastion이 Secret을 직접 조회 (jq 사용)
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$BASTION_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              \"set +x\",
              \"SECRET_JSON=\\$(aws secretsmanager get-secret-value --secret-id $DB_SECRET_ARN --query SecretString --output text --region ap-northeast-2)\",
              \"DB_USER=\\$(echo \\$SECRET_JSON | jq -r .username)\",
              \"DB_PASS=\\$(echo \\$SECRET_JSON | jq -r .password)\",
              \"if [ -z \\\"\\$DB_USER\\\" ] || [ -z \\\"\\$DB_PASS\\\" ]; then echo 'ERROR: empty credentials'; exit 1; fi\",
              \"PGPASSWORD=\\$DB_PASS psql -h $DB_HOST -U \\$DB_USER -d evscrap -c 'SELECT 1 as connected;'\",
              \"echo 'DB connection OK'\"
            ]" \
            --query 'Command.CommandId' --output text)
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$BASTION_ID" 2>/dev/null || true
          
          # SSM 실행 결과 확인
          STATUS1=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$BASTION_ID" \
            --query 'Status' --output text 2>/dev/null || echo "Unknown")
          echo "DB connection check: $STATUS1"
          if [ "$STATUS1" != "Success" ]; then
            aws ssm get-command-invocation --command-id "$COMMAND_ID" --instance-id "$BASTION_ID" \
              --query 'StandardErrorContent' --output text 2>/dev/null || true
            echo "❌ DB connection failed"; exit 1
          fi
          echo "✅ DB connection verified"
          
          # 2) idempotency_records v2 마이그레이션 (jq 사용)
          CMD_ID2=$(aws ssm send-command \
            --instance-ids "$BASTION_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              \"set +x\",
              \"SECRET_JSON=\\$(aws secretsmanager get-secret-value --secret-id $DB_SECRET_ARN --query SecretString --output text --region ap-northeast-2)\",
              \"DB_USER=\\$(echo \\$SECRET_JSON | jq -r .username)\",
              \"DB_PASS=\\$(echo \\$SECRET_JSON | jq -r .password)\",
              \"if [ -z \\\"\\$DB_USER\\\" ] || [ -z \\\"\\$DB_PASS\\\" ]; then echo 'ERROR: empty credentials'; exit 1; fi\",
              \"echo $SQL_B64 | base64 -d | PGPASSWORD=\\$DB_PASS psql -h $DB_HOST -U \\$DB_USER -d evscrap\",
              \"echo 'Migration applied'\"
            ]" \
            --query 'Command.CommandId' --output text)
          aws ssm wait command-executed \
            --command-id "$CMD_ID2" \
            --instance-id "$BASTION_ID" 2>/dev/null || true
          
          STATUS2=$(aws ssm get-command-invocation \
            --command-id "$CMD_ID2" \
            --instance-id "$BASTION_ID" \
            --query 'Status' --output text 2>/dev/null || echo "Unknown")
          echo "Migration step: $STATUS2"
          if [ "$STATUS2" != "Success" ]; then
            aws ssm get-command-invocation --command-id "$CMD_ID2" --instance-id "$BASTION_ID" \
              --query 'StandardErrorContent' --output text 2>/dev/null || true
            echo "❌ Migration failed"; exit 1
          fi
          echo "✅ idempotency_records v2 migration applied"

      # ---- Resolve Outputs + Smoke Tests ----
      - name: Resolve CDK Outputs
        id: outputs
        run: |
          node scripts/resolve-outputs.mjs infra/cdk-outputs.json > /tmp/evscrap.outputs.env
          echo "--- Resolved Outputs ---"
          cat /tmp/evscrap.outputs.env
          echo "------------------------"
          while IFS= read -r line; do
            echo "$line" >> $GITHUB_ENV
          done < /tmp/evscrap.outputs.env

      # ---- Smoke Test: /health ----
      - name: Smoke Test (health)
        run: |
          echo "Testing: ${API_BASE}health"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_BASE}health")
          echo "Health check: HTTP $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "❌ Health smoke test failed!"
            exit 1
          fi
          echo "✅ Health smoke test passed!"

      # ---- DB Smoke Test (Cognito 인증 + DB Read/Write) ----
      - name: DB Smoke Test
        env:
          TEST_USER_USERNAME: ${{ secrets.TEST_USER_USERNAME }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
          TEST_ADMIN_USERNAME: ${{ secrets.TEST_ADMIN_USERNAME }}
          TEST_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASSWORD }}
        run: node scripts/db-smoke.mjs

      # ---- Idempotency-Key E2E Test ----
      - name: Idempotency E2E Test
        env:
          TEST_USER_USERNAME: ${{ secrets.TEST_USER_USERNAME }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
        run: node scripts/e2e-idempotency.mjs

      - name: Output deployment info
        run: |
          echo "✅ Full deployment completed (with DB smoke)"
          echo "AWS Account: ${{ env.AWS_ACCOUNT_ID }}"
          echo "AWS Region: ${{ env.AWS_REGION }}"
          echo "API URL: ${{ env.API_BASE }}"
