openapi: 3.0.3
info:
  title: evscrap API
  version: 1.0.0-phase1a
  description: |
    evscrap 보수적 MVP API 계약 (Phase 1-A)
    
    폐차장 관리 및 부품 정산을 위한 RESTful API입니다.
    User API와 Admin API로 분리되어 있으며, 각각 별도의 인증을 사용합니다.

servers:
  - url: https://api.evscrap.example.com
    description: Production server
  - url: http://localhost:3000
    description: Local development server

paths:
  # User API
  /user/v1/tenants/submit:
    post:
      summary: 테넌트 등록 제출
      operationId: submitTenant
      tags: [User - Tenant]
      security:
        - scrapyardJwt: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [display_name, phone_number]
              properties:
                display_name:
                  type: string
                  example: "서울폐차장"
                phone_number:
                  type: string
                  pattern: '^\+82[0-9]{9,11}$'
                  example: "+821012345678"
                business_number:
                  type: string
                  example: "123-45-67890"
                address:
                  type: string
                  example: "서울시 강남구"
      responses:
        '201':
          description: 테넌트 등록 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/v1/me:
    get:
      summary: 현재 사용자 정보 조회
      operationId: getCurrentUser
      tags: [User - Tenant]
      security:
        - scrapyardJwt: []
      responses:
        '200':
          description: 사용자 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/v1/cases:
    post:
      summary: 차량 Case 생성
      operationId: createCase
      tags: [User - Case]
      security:
        - scrapyardJwt: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [vin]
              properties:
                vin:
                  type: string
                  example: "KMHXX00XXXX000000"
                make:
                  type: string
                  example: "현대"
                model:
                  type: string
                  example: "아이오닉5"
                year:
                  type: integer
                  example: 2023
      responses:
        '201':
          description: Case 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Case'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/TenantNotApproved'

  /user/v1/lots:
    post:
      summary: 부품 Lot 생성
      operationId: createLot
      tags: [User - Lot]
      security:
        - scrapyardJwt: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [part_type]
              properties:
                parent_case_id:
                  type: string
                  format: uuid
                  nullable: true
                  example: "550e8400-e29b-41d4-a716-446655440000"
                part_type:
                  $ref: '#/components/schemas/PartType'
                quantity:
                  type: integer
                  default: 1
                  example: 1
                weight_kg:
                  type: number
                  format: float
                  example: 250.5
      responses:
        '201':
          description: Lot 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Lot'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/v1/evidence/presign:
    post:
      summary: Presigned URL 생성
      operationId: createPresignedUrl
      tags: [User - Evidence]
      security:
        - scrapyardJwt: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [filename, mime_type]
              properties:
                filename:
                  type: string
                  example: "photo_001.jpg"
                mime_type:
                  type: string
                  example: "image/jpeg"
                target_type:
                  type: string
                  enum: [CASE, LOT]
                  description: 증빙을 연결할 대상 유형 (선택)
                target_id:
                  type: string
                  format: uuid
                  description: 증빙을 연결할 대상 ID (선택)
      responses:
        '200':
          description: Presigned URL 생성 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  presigned_url:
                    type: string
                    format: uri
                  evidence_id:
                    type: string
                    format: uuid
                  s3_key:
                    type: string
                  expires_at:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/v1/evidence:
    post:
      summary: Evidence 등록
      operationId: registerEvidence
      tags: [User - Evidence]
      security:
        - scrapyardJwt: []
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [evidence_id, sha256, size_bytes, s3_key]
              properties:
                evidence_id:
                  type: string
                  format: uuid
                sha256:
                  type: string
                  pattern: '^[a-f0-9]{64}$'
                size_bytes:
                  type: integer
                s3_key:
                  type: string
                  description: presign에서 받은 S3 키
                mime_type:
                  type: string
                  description: MIME 타입 (선택, 기본 application/octet-stream)
                captured_at:
                  type: string
                  format: date-time
                target_type:
                  type: string
                  enum: [CASE, LOT]
                  description: 증빙 연결 대상 유형 (선택)
                target_id:
                  type: string
                  format: uuid
                  description: 증빙 연결 대상 ID (선택)
      responses:
        '201':
          description: Evidence 등록 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Evidence'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/v1/evidence/{evidenceId}/download-url:
    get:
      summary: 증빙 파일 다운로드 URL 생성
      description: |
        Presigned GET URL을 발급하여 증빙 파일 다운로드를 허용한다.
        URL은 120초 후 만료된다. tenant 격리가 적용된다.
      operationId: getEvidenceDownloadUrl
      tags: [User - Evidence]
      security:
        - scrapyardJwt: []
      parameters:
        - name: evidenceId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 다운로드 URL 생성 성공
          content:
            application/json:
              schema:
                type: object
                required: [download_url, expires_at, evidence_id, filename]
                properties:
                  download_url:
                    type: string
                    format: uri
                    description: Presigned GET URL (120초 만료)
                  expires_at:
                    type: string
                    format: date-time
                  evidence_id:
                    type: string
                    format: uuid
                  filename:
                    type: string
                  mime_type:
                    type: string
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/v1/{targetType}/{targetId}/evidence:
    get:
      summary: 대상(CASE/LOT)에 연결된 증빙 목록 조회
      operationId: listEvidenceByTarget
      tags: [User - Evidence]
      security:
        - scrapyardJwt: []
      parameters:
        - name: targetType
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/TargetType'
        - name: targetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 증빙 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Evidence'
                  total:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/v1/settlements:
    get:
      summary: 내 정산 목록 조회
      operationId: listUserSettlements
      tags: [User - Settlement]
      security:
        - scrapyardJwt: []
      responses:
        '200':
          description: 정산 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Settlement'
                  total:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/v1/{targetType}/{targetId}/events:
    post:
      summary: 이벤트 생성
      operationId: createEvent
      tags: [User - Event]
      security:
        - scrapyardJwt: []
      parameters:
        - name: targetType
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/TargetType'
        - name: targetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EventCreateRequest'
      responses:
        '201':
          description: 이벤트 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /user/v1/{targetType}/{targetId}/timeline:
    get:
      summary: 타임라인 조회
      operationId: getTimeline
      tags: [User - Event]
      security:
        - scrapyardJwt: []
      parameters:
        - name: targetType
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/TargetType'
        - name: targetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 타임라인 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/v1/{targetType}/{targetId}/settlement:
    get:
      summary: 정산 정보 조회
      operationId: getSettlement
      tags: [User - Settlement]
      security:
        - scrapyardJwt: []
      parameters:
        - name: targetType
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/TargetType'
        - name: targetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 정산 정보 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settlement'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/v1/{targetType}/{targetId}/settlement/breakdown:
    get:
      summary: 정산 항목별 breakdown 조회
      description: |
        정산의 세부 항목(breakdown items)을 조회한다.
        정합성 검증 결과(consistency)도 포함된다.
      operationId: getSettlementBreakdown
      tags: [User - Settlement]
      security:
        - scrapyardJwt: []
      parameters:
        - name: targetType
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/TargetType'
        - name: targetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Breakdown 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SettlementBreakdown'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/v1/events/{eventId}/anchor:
    get:
      summary: 앵커 상태 조회
      operationId: getAnchorStatus
      tags: [User - Event]
      security:
        - scrapyardJwt: []
      parameters:
        - name: eventId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 앵커 상태 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlockchainAnchor'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # Admin API
  /admin/v1/tenants:
    get:
      summary: 테넌트 목록 조회
      operationId: listTenants
      tags: [Admin - Tenant]
      security:
        - adminJwt: []
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/TenantStatus'
      responses:
        '200':
          description: 테넌트 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenants:
                    type: array
                    items:
                      $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/v1/tenants/{id}:
    get:
      summary: 테넌트 상세 조회
      operationId: getTenant
      tags: [Admin - Tenant]
      security:
        - adminJwt: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 테넌트 상세 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/v1/tenants/{id}/approve:
    post:
      summary: 테넌트 승인
      operationId: approveTenant
      tags: [Admin - Tenant]
      security:
        - adminJwt: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notes:
                  type: string
      responses:
        '200':
          description: 테넌트 승인 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Tenant'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/v1/events:
    get:
      summary: 이벤트 목록 조회
      operationId: listEvents
      tags: [Admin - Event]
      security:
        - adminJwt: []
      parameters:
        - name: target_type
          in: query
          schema:
            $ref: '#/components/schemas/TargetType'
        - name: event_type
          in: query
          schema:
            $ref: '#/components/schemas/EventType'
        - name: anchor_status
          in: query
          schema:
            $ref: '#/components/schemas/AnchorStatus'
      responses:
        '200':
          description: 이벤트 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/v1/events/{eventId}:
    get:
      summary: 이벤트 상세 조회
      operationId: getEvent
      tags: [Admin - Event]
      security:
        - adminJwt: []
      parameters:
        - name: eventId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 이벤트 상세 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/v1/settlements:
    get:
      summary: 정산 목록 조회
      operationId: listSettlements
      tags: [Admin - Settlement]
      security:
        - adminJwt: []
      parameters:
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/SettlementStatus'
      responses:
        '200':
          description: 정산 목록 조회 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  settlements:
                    type: array
                    items:
                      $ref: '#/components/schemas/Settlement'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/v1/settlements/{id}:
    get:
      summary: 정산 상세 조회
      operationId: getSettlementById
      tags: [Admin - Settlement]
      security:
        - adminJwt: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 정산 상세 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settlement'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/v1/settlements/{id}/breakdown:
    get:
      summary: 정산 breakdown 조회 (Admin)
      operationId: adminGetSettlementBreakdown
      tags: [Admin - Settlement]
      security:
        - adminJwt: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Breakdown 조회 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SettlementBreakdown'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/v1/settlements/{id}/approve:
    post:
      summary: 정산 승인
      description: 게이트 이벤트의 블록체인 앵커가 VERIFIED여야만 승인 가능
      operationId: approveSettlement
      tags: [Admin - Settlement]
      security:
        - adminJwt: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                notes:
                  type: string
      responses:
        '200':
          description: 정산 승인 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settlement'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/AnchorNotVerified'

  /admin/v1/settlements/{id}/commit:
    post:
      summary: 정산 확정
      description: 게이트 이벤트의 블록체인 앵커가 VERIFIED여야만 확정 가능
      operationId: commitSettlement
      tags: [Admin - Settlement]
      security:
        - adminJwt: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                receipt_hash:
                  type: string
      responses:
        '200':
          description: 정산 확정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Settlement'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          $ref: '#/components/responses/AnchorNotVerified'

  /admin/v1/policies:
    post:
      summary: 정책 생성
      operationId: createPolicy
      tags: [Admin - Policy]
      security:
        - adminJwt: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [policy_type, version, policy_body]
              properties:
                policy_type:
                  $ref: '#/components/schemas/PolicyType'
                version:
                  type: string
                  example: "m0.v1"
                policy_body:
                  type: object
                  additionalProperties: true
      responses:
        '201':
          description: 정책 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/v1/policies/{id}/activate:
    post:
      summary: 정책 활성화
      operationId: activatePolicy
      tags: [Admin - Policy]
      security:
        - adminJwt: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 정책 활성화 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/v1/audit/missing-anchors:
    get:
      summary: 앵커 누락 감사
      operationId: auditMissingAnchors
      tags: [Admin - Audit]
      security:
        - adminJwt: []
      responses:
        '200':
          description: 앵커 누락 감사 결과
          content:
            application/json:
              schema:
                type: object
                properties:
                  missing_anchors:
                    type: array
                    items:
                      type: object
                      properties:
                        event_id:
                          type: string
                          format: uuid
                        event_type:
                          $ref: '#/components/schemas/EventType'
                        created_at:
                          type: string
                          format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ─── P2-1.5: Admin 조회 API 추가 ───

  /admin/v1/cases:
    get:
      summary: 케이스 목록 조회
      operationId: adminListCases
      tags: [Admin - Case]
      security:
        - adminJwt: []
      parameters:
        - name: tenant_id
          in: query
          schema:
            type: string
            format: uuid
        - name: vin
          in: query
          schema:
            type: string
        - name: from
          in: query
          schema:
            type: string
            format: date-time
        - name: to
          in: query
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 200
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 케이스 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Case'
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/v1/cases/{caseId}:
    get:
      summary: 케이스 상세 조회 (lots + 이벤트 요약 포함)
      operationId: adminGetCase
      tags: [Admin - Case]
      security:
        - adminJwt: []
      parameters:
        - name: caseId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 케이스 상세
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Case'
                  - type: object
                    properties:
                      lots:
                        type: array
                        items:
                          $ref: '#/components/schemas/Lot'
                      event_count:
                        type: integer
                      latest_event:
                        $ref: '#/components/schemas/Event'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /admin/v1/{targetType}/{targetId}/timeline:
    get:
      summary: 타임라인 조회 (Admin)
      operationId: adminGetTimeline
      tags: [Admin - Timeline]
      security:
        - adminJwt: []
      parameters:
        - name: targetType
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/TargetType'
        - name: targetId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 200
            maximum: 500
        - name: before
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: 타임라인
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'
                  target_type:
                    $ref: '#/components/schemas/TargetType'
                  target_id:
                    type: string
                    format: uuid
        '401':
          $ref: '#/components/responses/Unauthorized'

  /admin/v1/evidence:
    get:
      summary: 증빙 목록 조회 (tenant 기준 + presigned GET URL)
      description: |
        Evidence 테이블에는 targetType/targetId가 없으므로 tenant_id 기준 조회.
        각 항목에 10분 만료 presigned GET URL 포함.
      operationId: adminListEvidence
      tags: [Admin - Evidence]
      security:
        - adminJwt: []
      parameters:
        - name: tenant_id
          in: query
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 200
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: 증빙 목록 (presigned URL 포함)
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      allOf:
                        - $ref: '#/components/schemas/Evidence'
                        - type: object
                          properties:
                            presigned_url:
                              type: string
                              format: uri
                              nullable: true
                            presign_expires_in:
                              type: integer
                              description: presigned URL 만료 시간(초)
                  limit:
                    type: integer
                  offset:
                    type: integer
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'

components:
  securitySchemes:
    scrapyardJwt:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: 사용자(폐차장) Cognito JWT
    adminJwt:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: 관리자 Cognito JWT

  parameters:
    IdempotencyKey:
      name: Idempotency-Key
      in: header
      required: false
      schema:
        type: string
        format: uuid
      description: 멱등성 키 (UUID 권장)

  schemas:
    TenantStatus:
      type: string
      enum: [PENDING, APPROVED, REJECTED, SUSPENDED]

    PartType:
      type: string
      enum: [MOTOR, BATTERY_PACK, INVERTER, OTHER]

    EventType:
      type: string
      enum:
        - TENANT_SUBMITTED
        - TENANT_APPROVED
        - CASE_CREATED
        - LOT_CREATED
        - M0_QUOTED
        - INBOUND_CHECKED
        - GRADING_COMPLETED
        - DELTA_CALCULATED
        - SETTLEMENT_APPROVED
        - SETTLEMENT_COMMITTED

    AnchorStatus:
      type: string
      enum: [NONE, PENDING, VERIFIED, FAILED]

    PolicyType:
      type: string
      enum: [M0, DELTA, SCORE, WORKFLOW]

    SettlementStatus:
      type: string
      enum: [DRAFT, READY_FOR_APPROVAL, APPROVED, COMMITTED]

    ReuseGrade:
      type: string
      enum: [A, B, C, UNKNOWN]
      description: 재사용 등급 (A=우수, B=양호, C=불량, UNKNOWN=미확인)

    RecycleGrade:
      type: string
      enum: [A, B, C, UNKNOWN]
      description: 재활용 등급 (A=우수, B=양호, C=불량, UNKNOWN=미확인)

    TargetType:
      type: string
      enum: [CASE, LOT]

    Tenant:
      type: object
      required: [tenant_id, status, display_name, phone_number, created_at]
      properties:
        tenant_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/TenantStatus'
        display_name:
          type: string
        phone_number:
          type: string
          pattern: '^\+82[0-9]{9,11}$'
        business_number:
          type: string
        address:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        approved_at:
          type: string
          format: date-time
        approved_by:
          type: string

    Case:
      type: object
      required: [case_id, vin, tenant_id, created_at]
      properties:
        case_id:
          type: string
          format: uuid
        vin:
          type: string
          description: VIN (Vehicle Identification Number)
        make:
          type: string
        model:
          type: string
        year:
          type: integer
        tenant_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time

    Lot:
      type: object
      required: [lot_id, part_type, quantity, tenant_id, created_at]
      properties:
        lot_id:
          type: string
          format: uuid
        parent_case_id:
          type: string
          format: uuid
          nullable: true
        part_type:
          $ref: '#/components/schemas/PartType'
        quantity:
          type: integer
        weight_kg:
          type: number
          format: float
        tenant_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time

    Evidence:
      type: object
      required: [evidence_id, s3_bucket, s3_key, sha256, mime_type, size_bytes, uploaded_at, tenant_id]
      properties:
        evidence_id:
          type: string
          format: uuid
        s3_bucket:
          type: string
        s3_key:
          type: string
        sha256:
          type: string
          pattern: '^[a-f0-9]{64}$'
        mime_type:
          type: string
        size_bytes:
          type: integer
        captured_at:
          type: string
          format: date-time
        uploaded_at:
          type: string
          format: date-time
        tenant_id:
          type: string
          format: uuid
        target_type:
          type: string
          enum: [CASE, LOT]
          nullable: true
          description: 증빙 연결 대상 유형
        target_id:
          type: string
          format: uuid
          nullable: true
          description: 증빙 연결 대상 ID

    Event:
      type: object
      required: [event_id, target_type, target_id, event_type, occurred_at, canonical_hash, anchor_status, tenant_id]
      properties:
        event_id:
          type: string
          format: uuid
        target_type:
          $ref: '#/components/schemas/TargetType'
        target_id:
          type: string
          format: uuid
        event_type:
          $ref: '#/components/schemas/EventType'
        occurred_at:
          type: string
          format: date-time
        policy_refs:
          type: object
          additionalProperties: true
          example:
            m0: "m0.v1"
            delta: "delta.v1"
        payload:
          oneOf:
            - $ref: '#/components/schemas/GradingCompletedPayload'
            - type: object
        canonical_hash:
          type: string
          pattern: '^[a-f0-9]{64}$'
        anchor_status:
          $ref: '#/components/schemas/AnchorStatus'
        anchor_txid:
          type: string
        prev_event_id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid

    GradingCompletedPayload:
      type: object
      required: [reuse_grade, recycle_grade]
      properties:
        reuse_grade:
          $ref: '#/components/schemas/ReuseGrade'
        recycle_grade:
          $ref: '#/components/schemas/RecycleGrade'
        soh:
          oneOf:
            - type: number
            - type: string
          description: SoH (State of Health) 입력값
        notes:
          type: string

    EventCreateRequest:
      type: object
      required: [event_type, occurred_at, payload]
      properties:
        event_type:
          $ref: '#/components/schemas/EventType'
        occurred_at:
          type: string
          format: date-time
        policy_refs:
          type: object
          additionalProperties: true
        payload:
          type: object
      discriminator:
        propertyName: event_type
        mapping:
          GRADING_COMPLETED: '#/components/schemas/GradingCompletedEventCreateRequest'
          INBOUND_CHECKED: '#/components/schemas/InboundCheckedEventCreateRequest'
          DELTA_CALCULATED: '#/components/schemas/DeltaCalculatedEventCreateRequest'
          SETTLEMENT_APPROVED: '#/components/schemas/SettlementApprovedEventCreateRequest'
          SETTLEMENT_COMMITTED: '#/components/schemas/SettlementCommittedEventCreateRequest'
          TENANT_SUBMITTED: '#/components/schemas/GenericEventCreateRequest'
          TENANT_APPROVED: '#/components/schemas/GenericEventCreateRequest'
          CASE_CREATED: '#/components/schemas/GenericEventCreateRequest'
          LOT_CREATED: '#/components/schemas/GenericEventCreateRequest'
          M0_QUOTED: '#/components/schemas/GenericEventCreateRequest'

    GenericEventCreateRequest:
      type: object
      required: [event_type, occurred_at, payload]
      properties:
        event_type:
          $ref: '#/components/schemas/EventType'
        occurred_at:
          type: string
          format: date-time
        policy_refs:
          type: object
          additionalProperties: true
        payload:
          type: object
          additionalProperties: true

    GradingCompletedEventCreateRequest:
      type: object
      required: [event_type, occurred_at, payload]
      properties:
        event_type:
          type: string
          enum: [GRADING_COMPLETED]
        occurred_at:
          type: string
          format: date-time
        policy_refs:
          type: object
          additionalProperties: true
          example:
            score: "score.v1"
        payload:
          $ref: '#/components/schemas/GradingCompletedPayload'
      example:
        event_type: GRADING_COMPLETED
        occurred_at: "2026-02-05T11:45:00Z"
        policy_refs:
          score: "score.v1"
        payload:
          reuse_grade: "B"
          recycle_grade: "A"
          soh: 85.5
          notes: "SoH 85.5%, 재사용 양호, 재활용 우수"

    InboundCheckedEventCreateRequest:
      type: object
      required: [event_type, occurred_at, payload]
      properties:
        event_type:
          type: string
          enum: [INBOUND_CHECKED]
        occurred_at:
          type: string
          format: date-time
        policy_refs:
          type: object
          additionalProperties: true
        payload:
          type: object
          properties:
            inspector_id:
              type: string
            checked_at:
              type: string
              format: date-time
            notes:
              type: string

    DeltaCalculatedEventCreateRequest:
      type: object
      required: [event_type, occurred_at, payload]
      properties:
        event_type:
          type: string
          enum: [DELTA_CALCULATED]
        occurred_at:
          type: string
          format: date-time
        policy_refs:
          type: object
          additionalProperties: true
        payload:
          type: object
          properties:
            delta_amount:
              type: number
              format: double
            policy_version:
              type: string
            notes:
              type: string

    SettlementApprovedEventCreateRequest:
      type: object
      required: [event_type, occurred_at, payload]
      properties:
        event_type:
          type: string
          enum: [SETTLEMENT_APPROVED]
        occurred_at:
          type: string
          format: date-time
        policy_refs:
          type: object
          additionalProperties: true
        payload:
          type: object
          properties:
            approved_by:
              type: string
            approved_amount:
              type: number
              format: double
            notes:
              type: string

    SettlementCommittedEventCreateRequest:
      type: object
      required: [event_type, occurred_at, payload]
      properties:
        event_type:
          type: string
          enum: [SETTLEMENT_COMMITTED]
        occurred_at:
          type: string
          format: date-time
        policy_refs:
          type: object
          additionalProperties: true
        payload:
          type: object
          properties:
            committed_by:
              type: string
            receipt_hash:
              type: string
            notes:
              type: string

    BlockchainAnchor:
      type: object
      required: [anchor_status]
      properties:
        anchor_status:
          $ref: '#/components/schemas/AnchorStatus'
        anchor_txid:
          type: string
        verified_at:
          type: string
          format: date-time

    Policy:
      type: object
      required: [policy_id, policy_type, version, is_active, policy_body, created_at]
      properties:
        policy_id:
          type: string
          format: uuid
        policy_type:
          $ref: '#/components/schemas/PolicyType'
        version:
          type: string
        is_active:
          type: boolean
        policy_body:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time

    SettlementBreakdownItem:
      type: object
      required: [id, code, title, category, amount, created_at]
      properties:
        id:
          type: string
        code:
          type: string
          description: 항목 코드 (BASE_MIN, GRADE_BONUS, TRANSPORT 등)
        title:
          type: string
          description: 표시명
        category:
          type: string
          enum: [MIN, BONUS, DEDUCTION, LOGISTICS, OTHER]
        amount:
          type: integer
          description: 금액 (KRW, 음수 허용)
        quantity:
          type: number
          nullable: true
        unit:
          type: string
          nullable: true
        unit_price:
          type: integer
          nullable: true
        evidence_ref:
          type: string
          nullable: true
        note:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time

    SettlementBreakdown:
      type: object
      required: [settlement_id, target_type, target_id, status, amount_total, items, summary, consistency]
      properties:
        settlement_id:
          type: string
          format: uuid
        target_type:
          $ref: '#/components/schemas/TargetType'
        target_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/SettlementStatus'
        amount_min:
          type: number
          nullable: true
        amount_bonus:
          type: number
          nullable: true
        amount_total:
          type: number
        items:
          type: array
          items:
            $ref: '#/components/schemas/SettlementBreakdownItem'
        summary:
          type: object
          properties:
            min:
              type: integer
            bonus:
              type: integer
            deduction:
              type: integer
            other:
              type: integer
            total:
              type: integer
        consistency:
          type: object
          properties:
            rule:
              type: string
              description: 'Fixed rule: amount_min=sum(MIN); amount_bonus=sum(NON_MIN); amount_total=sum(ALL)'
            ok:
              type: boolean
              description: 'true only when all 3 sub-checks pass (min_ok && bonus_ok && total_ok)'
            details:
              type: object
              description: 'Optional detailed sub-check results'
              properties:
                min_ok:
                  type: boolean
                bonus_ok:
                  type: boolean
                total_ok:
                  type: boolean

    Settlement:
      type: object
      required: [settlement_id, target_type, target_id, status, amount_total, created_at]
      properties:
        settlement_id:
          type: string
          format: uuid
        target_type:
          $ref: '#/components/schemas/TargetType'
        target_id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/SettlementStatus'
        amount_min:
          type: number
          format: double
        amount_bonus:
          type: number
          format: double
        amount_total:
          type: number
          format: double
        receipt_hash:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      required: [error_code, message]
      properties:
        error_code:
          type: string
          enum:
            - ANCHOR_NOT_VERIFIED
            - TENANT_NOT_APPROVED
            - VALIDATION_ERROR
            - RESOURCE_NOT_FOUND
            - UNAUTHORIZED
            - FORBIDDEN
            - INTERNAL_ERROR
        message:
          type: string
        details:
          type: object
          additionalProperties: true
        trace_id:
          type: string
          format: uuid

  responses:
    ValidationError:
      description: 입력 검증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error_code: VALIDATION_ERROR
            message: "입력 값이 올바르지 않습니다"

    Unauthorized:
      description: 인증 실패
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error_code: UNAUTHORIZED
            message: "인증이 필요합니다"

    NotFound:
      description: 리소스를 찾을 수 없음
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error_code: RESOURCE_NOT_FOUND
            message: "요청한 리소스를 찾을 수 없습니다"

    TenantNotApproved:
      description: 테넌트 미승인
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error_code: TENANT_NOT_APPROVED
            message: "테넌트가 아직 승인되지 않았습니다"

    AnchorNotVerified:
      description: 블록체인 앵커 미검증
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error_code: ANCHOR_NOT_VERIFIED
            message: "게이트 이벤트의 블록체인 앵커가 검증되지 않았습니다"
